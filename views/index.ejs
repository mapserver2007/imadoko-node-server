<!DOCTYPE html>
<html>
<head>
    <title>websocket test</title>
    <meta charset="UTF-8"/>
    <script src='http://maps.google.com/maps/api/js?sensor=false' type='text/javascript'></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type="text/javascript" src="/views/mix.js"></script>
    <script type="text/javascript" src="/views/mix.modules.js"></script>
    <script type="text/javascript">
    Mixjs.module("WebSocketHerokuClient", {
        include: WebSocketClient,

        connect: function(webSocketInfo) {
            this.parent.connect(webSocketInfo);
            if (typeof webSocketInfo === 'object') {
                this.webSocketInfo.keepAlive = webSocketInfo.keepAlive || this.webSocketInfo.keepAlive;
                this.webSocketInfo.keepAliveInterval = webSocketInfo.keepAliveInterval || this.webSocketInfo.keepAliveInterval;
            }
            if (this.webSocketInfo.keepAlive) {
                this._keepAlive();
            }
        },

        /**
         * 接続を維持する
         */
        _keepAlive: function() {
            var self = this;
            this._timerId = setInterval(function() {
                if (self.connection !== null) {
                    if (self.connection.readyState === 1) {
                        self.connection.send(JSON.stringify({request: "polling"}));
                    }
                    else {
                        if (self.connection) {
                            self.connection.close();
                            self.connection = null;
                            clearInterval(self._timerId);
                        }
                        self.connect();
                    }
                }
            }, this.webSocketInfo.keepAliveInterval);
        }
    })

    var obj = WebSocketHerokuClient;
    obj.connect({
        url: "ws://" + location.host,
        keepAlive: true,
        keepAliveInterval: 3000,
        autoReconnect: true
    });

    obj.getJSON(function(data) {
        drawMap(data.lat, data.lng);
        document.getElementById("result").innerHTML += "<p>" + JSON.stringify(data) + "</p>";
    });

    window.__MAP__ = {};

    jQuery(function() {
        google.maps.event.addDomListener(window, 'load', function() {
            drawMap("35.643746", "139.826238");
        });
        jQuery("#move").on("click", moveMap);

        $("#getPosition").on("click", function() {
            obj.send(JSON.stringify({request: "getPosition", userId: "ryuichi"}));
        });
    });

    // 指定した位置に移動する
    function moveMap() {
        var lat = jQuery("#__lat__").html(),
            lng = jQuery("#__lng__").html();
        var latlng = new google.maps.LatLng(lat, lng);
        window.__MAP__.panTo(latlng);
        showHistory(lat, lng);
    }

    // 地図を描画する
    function drawMap(lat, lng) {
        jQuery("#map").empty();
        var latlng = new google.maps.LatLng(lat, lng);
        window.__MAP__ = new google.maps.Map(document.getElementById("map"), {
            zoom: 17,
            scaleControl: true,
            center: latlng,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        });
    }

    </script>

    <style type="text/css">
        div#map {
          width: 400px;
          height: 700px;
          float: left; }

        .clearfix {
          clear: both; }

        .hidden {
          display: none; }

    </style>

</head>
<body>
    <input type="button" id="getPosition" value="getPosition"/>
    <div id="map"></div>
    <div id='move'></div>
    <div id="result"></div>
</body>
</html>